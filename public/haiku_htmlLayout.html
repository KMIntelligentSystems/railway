<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ESGE Technical Review: Endoscopic Ultrasound-Guided Tissue Acquisition Meta-Analysis Dashboard">
    <meta name="theme-color" content="#1E40AF">
    <title>ESGE Technical Review - Endoscopic Ultrasound-Guided Tissue Acquisition</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Root Design System */
        :root {
            --primary: #1E40AF;
            --primary-light: #3B82F6;
            --secondary: #10B981;
            --accent: #F59E0B;
            --danger: #EF4444;
            --bg-main: #FFFFFF;
            --bg-alt: #F9FAFB;
            --bg-panel: #FBFBFD;
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --border-color: #E5E7EB;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
        }

        /* Reset & Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            width: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            color: var(--text-primary);
            background-color: var(--bg-alt);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Typography */
        h1 {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1.2;
            letter-spacing: -0.02em;
            margin-bottom: var(--spacing-md);
            color: var(--text-primary);
        }

        h2 {
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1.3;
            margin-top: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            color: var(--text-primary);
        }

        h3 {
            font-size: 1.25rem;
            font-weight: 600;
            line-height: 1.4;
            margin-top: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
            color: var(--text-primary);
        }

        h4 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            color: var(--text-secondary);
        }

        p {
            margin-bottom: var(--spacing-md);
            color: var(--text-primary);
            line-height: 1.7;
        }

        strong {
            font-weight: 600;
            color: var(--text-primary);
        }

        em {
            font-style: italic;
            color: var(--text-secondary);
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: var(--spacing-xl) var(--spacing-lg);
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header h1 {
            color: white;
            margin: 0;
            font-size: 1.75rem;
        }

        header p {
            color: rgba(255, 255, 255, 0.9);
            margin: var(--spacing-sm) 0 0 0;
            font-size: 0.95rem;
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--spacing-xl) var(--spacing-lg);
        }

        /* Navigation */
        nav.section-nav {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-2xl);
            flex-wrap: wrap;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: var(--spacing-lg);
        }

        nav.section-nav a {
            padding: var(--spacing-md) var(--spacing-lg);
            text-decoration: none;
            color: var(--text-secondary);
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            cursor: pointer;
        }

        nav.section-nav a:hover {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        nav.section-nav a.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Grid System */
        .grid {
            display: grid;
            gap: var(--spacing-lg);
            grid-template-columns: 1fr;
        }

        .grid.two-col {
            grid-template-columns: 1fr 1fr;
        }

        .grid.three-col {
            grid-template-columns: repeat(3, 1fr);
        }

        /* Card Component */
        .card {
            background: var(--bg-main);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
        }
        
        .card .viz-wrapper {
    height: 400px; /* explicit height */
}



        .card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--primary-light);
        }

        .card.panel {
            background: var(--bg-panel);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: var(--spacing-md);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0;
            color: var(--text-primary);
        }

        .card-subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: var(--spacing-xs);
        }

        .card-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-md);
            background-color: var(--bg-alt);
            border: 1px solid var(--border-color);
            border-radius: 999px;
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .card-content {
            color: var(--text-primary);
            line-height: 1.8;
        }

        /* Visualization Container */
        .viz-container {
            position: relative;
            width: 100%;
            background: var(--bg-main);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            min-height: 400px;
        }

        .viz-wrapper {
            width: 100%;
            height: 100%;
            min-height: 400px;
        }

        .viz-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-lg) var(--spacing-lg) 0;
        }

        .viz-description {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-md);
            padding: 0 var(--spacing-lg);
            font-style: italic;
        }

        /* Section Styles */
        section {
            scroll-margin-top: 120px;
        }

        section.hero {
            text-align: center;
            padding: var(--spacing-2xl) var(--spacing-lg);
            background: linear-gradient(135deg, rgba(30, 64, 175, 0.05) 0%, rgba(16, 185, 129, 0.05) 100%);
            border-radius: 12px;
            margin-bottom: var(--spacing-2xl);
        }

        section.hero h2 {
            font-size: 2rem;
            margin-bottom: var(--spacing-lg);
        }

        section.hero p {
            font-size: 1.1rem;
            max-width: 800px;
            margin: 0 auto var(--spacing-lg);
        }

        /* Content Sections */
        .content-section {
            display: grid;
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-2xl);
        }

        .content-section.two-column {
            grid-template-columns: 1fr 1fr;
        }

        /* Report Styles */
        .report-section {
            background: var(--bg-main);
            border-left: 4px solid var(--primary);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            border-radius: 0 8px 8px 0;
        }

        .report-section h3 {
            color: var(--primary);
            margin-top: 0;
        }

        .report-section ul,
        .report-section ol {
            margin-left: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
        }

        .report-section li {
            margin-bottom: var(--spacing-sm);
            line-height: 1.7;
        }

        /* Key Findings Box */
        .findings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-lg);
            margin: var(--spacing-lg) 0;
        }

        .finding-card {
            background: linear-gradient(135deg, rgba(30, 64, 175, 0.05) 0%, rgba(30, 64, 175, 0.02) 100%);
            border: 1px solid var(--primary-light);
            border-radius: 8px;
            padding: var(--spacing-lg);
        }

        .finding-card .category {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--spacing-sm);
        }

        .finding-card .insight {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-md);
        }

        .finding-card .evidence {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
        }

        .finding-card .action {
            font-size: 0.9rem;
            color: var(--secondary);
            font-weight: 500;
        }

        /* Recommendation Box */
        .recommendation-box {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(16, 185, 129, 0.02) 100%);
            border-left: 4px solid var(--secondary);
            border-radius: 0 8px 8px 0;
            padding: var(--spacing-lg);
            margin: var(--spacing-lg) 0;
        }

        .recommendation-box h4 {
            color: var(--secondary);
            margin-top: 0;
        }

        /* Safety Alert */
        .safety-alert {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, rgba(239, 68, 68, 0.02) 100%);
            border-left: 4px solid var(--danger);
            border-radius: 0 8px 8px 0;
            padding: var(--spacing-lg);
            margin: var(--spacing-lg) 0;
        }

        .safety-alert h4 {
            color: var(--danger);
            margin-top: 0;
        }

        /* Metadata */
        .metadata {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-2xl);
        }

        .metadata-item {
            text-align: center;
            padding: var(--spacing-lg);
            background: var(--bg-alt);
            border-radius: 8px;
        }

        .metadata-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: var(--spacing-sm);
        }

        .metadata-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Footer */
        footer {
            background: var(--text-primary);
            color: white;
            padding: var(--spacing-2xl) var(--spacing-lg);
            margin-top: var(--spacing-2xl);
            text-align: center;
        }

        footer p {
            color: rgba(255, 255, 255, 0.8);
            margin: 0;
            font-size: 0.9rem;
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Focus Visible */
        *:focus-visible {
            outline: 3px solid var(--primary);
            outline-offset: 2px;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .container {
                padding: var(--spacing-lg) var(--spacing-md);
            }

            .grid.two-col,
            .grid.three-col,
            .content-section.two-column {
                grid-template-columns: 1fr;
            }

            .findings-grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.75rem;
            }

            h2 {
                font-size: 1.35rem;
            }

            header h1 {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 768px) {
            header {
                padding: var(--spacing-lg) var(--spacing-md);
            }

            header h1 {
                font-size: 1.25rem;
            }

            header p {
                font-size: 0.85rem;
            }

            h1 {
                font-size: 1.5rem;
            }

            h2 {
                font-size: 1.25rem;
            }

            h3 {
                font-size: 1.1rem;
            }

            .card {
                padding: var(--spacing-md);
            }

            nav.section-nav {
                flex-direction: column;
                gap: 0;
                border-bottom: none;
                padding-bottom: 0;
            }

            nav.section-nav a {
                border-left: 3px solid transparent;
                border-bottom: none;
                padding: var(--spacing-md) var(--spacing-lg) var(--spacing-md) var(--spacing-md);
                margin-bottom: var(--spacing-xs);
            }

            nav.section-nav a:hover,
            nav.section-nav a.active {
                border-left-color: var(--primary);
            }

            .metadata {
                grid-template-columns: 1fr;
            }

            .finding-card {
                padding: var(--spacing-md);
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: var(--spacing-md) var(--spacing-sm);
            }

            header {
                padding: var(--spacing-md) var(--spacing-sm);
            }

            header h1 {
                font-size: 1.1rem;
            }

            h1 {
                font-size: 1.35rem;
            }

            h2 {
                font-size: 1.15rem;
            }

            .card {
                padding: var(--spacing-md);
            }

            .card-title {
                font-size: 1.1rem;
            }

            .viz-container {
                min-height: 350px;
            }
        }

        /* Print Styles */
        @media print {
            header {
                position: static;
            }

            nav.section-nav {
                display: none;
            }

            .card {
                page-break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ccc;
            }

            body {
                background: white;
                color: #000;
            }
        }

        /* Dark Mode Support (Optional) */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-main: #1F2937;
                --bg-alt: #111827;
                --bg-panel: #0F172A;
                --text-primary: #F9FAFB;
                --text-secondary: #D1D5DB;
                --border-color: #374151;
                --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            }

            header {
                background: linear-gradient(135deg, #0F3460 0%, #16A34A 100%);
            }
        }

        /* SVG Styling for Charts */
        svg {
            width: 100%;
            height: 100%;
        }

        .axis path,
        .axis line {
            stroke: var(--border-color);
        }

        .axis text {
            fill: var(--text-secondary);
            font-size: 11px;
        }

        .grid line {
            stroke: var(--border-color);
            stroke-opacity: 0.1;
        }

        .tooltip {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            max-width: 320px;
            background: rgba(17, 24, 39, 0.96);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 12px;
            font-size: 12px;
            line-height: 1.5;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.18);
        }

        /* Loading State */
        .loading {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <h1>ESGE Technical Review: Endoscopic Ultrasound-Guided Tissue Acquisition</h1>
        <p>Meta-Analysis of Diagnostic Performance and Clinical Evidence</p>
    </header>

    <!-- Main Content -->
    <div class="container">
        <!-- Navigation -->
        <nav class="section-nav">
            <a href="#overview" class="active">Overview</a>
            <a href="#meta-analysis">Meta-Analysis</a>
            <a href="#needle-performance">Needle Performance</a>
            <a href="#clinical-guidance">Clinical Guidance</a>
            <a href="#recommendations">Recommendations</a>
        </nav>

        <!-- Hero Section -->
        <section class="hero" id="overview">
            <h2>Evidence-Based Assessment of EUS-Guided Tissue Acquisition</h2>
            <p>This comprehensive technical review synthesizes high-quality evidence from multiple meta-analyses examining endoscopic ultrasound-guided tissue acquisition techniques, needle designs, and sampling methodologies to inform clinical practice and establish evidence-based recommendations.</p>
        </section>

        <!-- Clinical Summary Section -->
        <section id="clinical-summary" class="content-section">
            <div class="card panel">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">Clinical Summary of Endoscopic Trial Findings</h2>
                        <p class="card-subtitle">Overview of Clinical Evidence</p>
                    </div>
                </div>
                <div class="card-content">
                    <h3>Overview of Clinical Evidence</h3>
                    <p>This comprehensive review synthesizes evidence from multiple high-quality studies examining endoscopic ultrasound-guided tissue acquisition techniques. The European Society of Gastrointestinal Endoscopy conducted this systematic evaluation using rigorous GRADE methodology, analyzing data from numerous randomized controlled trials and meta-analyses to establish evidence-based recommendations for clinical practice.</p>
                    <p>The body of evidence includes seven major meta-analyses published between 2020 and 2024, encompassing thousands of patients across international medical centers. This extensive dataset provides robust insights into the diagnostic performance and safety of various needle types and sampling techniques.</p>

                    <h3>Key Performance Metrics Explained</h3>
                    <p><strong>Diagnostic sensitivity</strong>—the ability to correctly identify disease when present—ranged from 76.6% to 86.7% across the reviewed meta-analyses. In practical terms, this means that when a lesion is cancerous, the biopsy procedure correctly identifies it as abnormal in approximately 8 out of 10 cases. The variation in sensitivity rates reflects differences in study populations, needle types, and techniques employed.</p>
                    <p><strong>Sample adequacy</strong>, which measures whether the obtained tissue is sufficient for pathological analysis, showed marked differences between needle types. Modern end-cutting FNB needles achieved adequacy rates exceeding 90%, meaning nearly all samples provided enough material for diagnosis. This represents a significant improvement over older needle designs.</p>

                    <h3>Clinical Significance of Results</h3>
                    <p>The data strongly supports the superiority of end-cutting FNB needles over traditional options. Network meta-analysis of 19 randomized trials showed that Franseen-type needles outperformed both reverse-bevel FNB needles (relative risk 1.21) and standard FNA needles (relative risk 1.21) for diagnostic accuracy. Fork-tip needles demonstrated similar advantages.</p>
                    <p>These findings translate to meaningful clinical benefits: fewer repeat procedures, faster time to diagnosis, and reduced patient anxiety. When a single procedure can reliably obtain diagnostic tissue, patients experience less discomfort and healthcare systems operate more efficiently.</p>

                    <h3>Practical Implications for Medical Practitioners</h3>
                    <p>For clinicians performing EUS-guided tissue acquisition, these findings offer clear guidance:</p>
                    <ul>
                        <li><strong>First,</strong> transitioning to end-cutting FNB needles for solid pancreatic lesions should be considered standard practice, supported by the highest level of evidence.</li>
                        <li><strong>Second,</strong> the fanning technique and wet-suction methods should be incorporated into routine practice to optimize sample quality.</li>
                        <li><strong>Third,</strong> the reduced need for rapid on-site evaluation when using modern FNB needles has important resource implications. Facilities without immediate cytopathology support can still achieve excellent diagnostic outcomes, potentially expanding access to these procedures in community settings.</li>
                        <li><strong>Finally,</strong> patient counseling can be informed by the favorable safety profile, with adverse events occurring in fewer than 1 in 10 procedures and serious complications being rare.</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Meta-Analysis Section -->
        <section id="meta-analysis" class="content-section">
            <h2>Meta-Analysis: Diagnostic Sensitivity Comparison</h2>
            <p>The following visualizations present findings from multiple meta-analyses examining diagnostic sensitivity and patient sample characteristics across published studies.</p>

            <div class="grid two-col">
                <!-- Bar Chart Card -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">Sensitivity by Study</h3>
                            <p class="card-subtitle">Diagnostic accuracy across reviewed trials</p>
                        </div>
                        <div class="card-badge" id="bar-count" aria-live="polite">Loading...</div>
                    </div>
                    <p class="viz-description">Bar chart comparing sensitivity percentages across studies. Hover for exact values. Click a bar to highlight related data across visualizations.</p>
                    <div id="meta_analysis_barchart" class="viz-wrapper" role="group" aria-label="Bar chart comparing sensitivity across studies"></div>
                    <div style="margin-top: var(--spacing-md); display: flex; flex-wrap: wrap; gap: var(--spacing-lg); font-size: 0.9rem;">
                        <span><span style="display: inline-block; width: 12px; height: 12px; background-color: #10b981; border-radius: 2px; margin-right: 6px; vertical-align: middle;"></span>High (≥ 90%)</span>
                        <span><span style="display: inline-block; width: 12px; height: 12px; background-color: #f59e0b; border-radius: 2px; margin-right: 6px; vertical-align: middle;"></span>Medium (80–89.9%)</span>
                        <span><span style="display: inline-block; width: 12px; height: 12px; background-color: #ef4444; border-radius: 2px; margin-right: 6px; vertical-align: middle;"></span>Low (< 80%)</span>
                    </div>
                </div>

                <!-- Scatter Plot Card -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">Sample Size vs Sensitivity</h3>
                            <p class="card-subtitle">Patient population and diagnostic yield relationship</p>
                        </div>
                        <div class="card-badge" id="scat-count" aria-live="polite">Loading...</div>
                    </div>
                    <p class="viz-description">Scatter plot showing the relationship between total patient count and sensitivity percentage. Point size reflects study weight.</p>
                    <div id="meta_analysis_scatterplot" class="viz-wrapper" role="group" aria-label="Scatter plot showing patient count versus sensitivity"></div>
                    <div style="margin-top: var(--spacing-md); font-size: 0.9rem; color: var(--text-secondary); font-style: italic;">
                        <strong>Interaction:</strong> Click a point to pin selection and cross-highlight the bar chart. Press Escape to clear.
                    </div>
                </div>
            </div>
        </section>

        <!-- Needle Performance Section -->
        <section id="needle-performance" class="content-section">
            <h2>Needle Performance Comparison</h2>
            <p>Comprehensive comparison of diagnostic yield and sample adequacy across different needle types and gauges used in endoscopic ultrasound-guided tissue acquisition.</p>

            <div class="card">
                <div class="card-header">
                    <div>
                        <h3 class="card-title">Accuracy and Adequacy by Needle Type</h3>
                        <p class="card-subtitle">Grouped bar chart analysis</p>
                    </div>
                </div>
                <p class="viz-description">Comparative performance metrics across needle types and gauges. Blue bars represent diagnostic yield (accuracy); orange bars represent sample adequacy.</p>
                <div id="needle_performance_chart" class="viz-wrapper" style="min-height: 450px;" role="group" aria-label="Grouped bar chart comparing needle performance"></div>
            </div>
        </section>

        <!-- Clinical Guidance Section -->
        <section id="clinical-guidance" class="content-section">
            <h2>Needle Preparation Guide for Endoscopic Ultrasound-Guided Tissue Acquisition</h2>

            <div class="card panel">
                <div class="card-header">
                    <h3 class="card-title" style="margin: 0;">Overview of Needle Types</h3>
                </div>
                <div class="card-content">
                    <p>Endoscopic ultrasound-guided tissue acquisition (EUS-TA) procedures rely on specialized needles designed to obtain diagnostic samples from lesions within the gastrointestinal tract and surrounding organs. The needles used in these procedures fall into two main categories: <strong>Fine Needle Aspiration (FNA) needles</strong> and <strong>Fine Needle Biopsy (FNB) needles</strong>.</p>

                    <p><strong>FNA needles</strong> are traditional aspiration devices that collect cellular material through suction. While effective, they typically require additional on-site evaluation to confirm sample adequacy. <strong>FNB needles</strong> represent a newer generation of devices designed to obtain core tissue samples, which provide pathologists with preserved tissue architecture for more definitive diagnoses.</p>

                    <p>Among FNB needles, two modern designs have emerged as superior performers: <strong>Franseen-type needles</strong> and <strong>Fork-tip needles</strong>. Franseen needles feature three symmetrically distributed cutting points that efficiently capture tissue cores. Fork-tip needles use two asymmetrical sharp points with six cutting edges to achieve similar results. Both designs are available from major manufacturers including Boston Scientific, Medtronic, and Cook Medical, typically in 19G, 22G, and 25G sizes.</p>
                </div>
            </div>

            <div class="card panel" style="margin-top: var(--spacing-lg);">
                <div class="card-header">
                    <h3 class="card-title" style="margin: 0;">Key Preparation Steps and Best Practices</h3>
                </div>
                <div class="card-content">
                    <p>Proper needle preparation begins with selecting the appropriate needle type based on the target lesion and clinical scenario. <strong>For solid pancreatic masses, end-cutting FNB needles (Franseen or Fork-tip designs) are strongly recommended</strong> based on high-quality evidence from multiple randomized controlled trials.</p>

                    <p>Before the procedure, practitioners should:</p>
                    <ul>
                        <li>Verify needle integrity and ensure the stylet moves freely within the needle shaft</li>
                        <li>Confirm appropriate needle gauge selection for the target lesion</li>
                        <li>Prepare adequate sampling containers and culture media if infection is suspected</li>
                        <li>Brief the pathology team on expected specimen type and diagnosis</li>
                    </ul>

                    <h4>Sampling Technique Optimization</h4>
                    <p>The sampling technique significantly impacts diagnostic yield. The <strong>fanning technique</strong>, where the needle is moved through multiple trajectories within the lesion, has been shown to significantly improve diagnostic accuracy.</p>

                    <p>Regarding suction methods, <strong>wet-suction and slow-pull techniques</strong> have demonstrated superior sample quality compared to traditional dry suction. These methods reduce blood contamination while maintaining adequate cellularity.</p>

                    <h4>Pass Requirements by Needle Type</h4>
                    <ul>
                        <li><strong>End-cutting FNB needles:</strong> Two passes typically sufficient when rapid on-site evaluation is unavailable</li>
                        <li><strong>Reverse-bevel needles:</strong> May require three passes</li>
                        <li><strong>FNA needles:</strong> Generally need at least four passes for optimal results</li>
                    </ul>
                </div>
            </div>

            <div class="card panel" style="margin-top: var(--spacing-lg);">
                <div class="card-header">
                    <h3 class="card-title" style="margin: 0;">Safety Considerations and Recommendations</h3>
                </div>
                <div class="card-content">
                    <p>The safety profile of EUS-guided tissue acquisition is generally favorable. <strong>Adverse event rates across major meta-analyses range from approximately 3% to 8.6%, with most events being mild and self-limiting.</strong></p>

                    <p><strong>Importantly, antibiotic prophylaxis is not routinely recommended for sampling solid masses,</strong> as infection rates remain low.</p>

                    <h4>Needle Gauge Considerations</h4>
                    <p>Practitioners should be aware that needle gauge selection may affect both diagnostic yield and complication rates:</p>
                    <ul>
                        <li><strong>Smaller gauge needles (25G)</strong> may be preferred for certain anatomical locations or when traversing vascular structures</li>
                        <li><strong>Larger gauge needles (19G)</strong> may be necessary for obtaining adequate tissue cores from firm lesions</li>
                    </ul>

                    <h4>Post-Procedure Monitoring</h4>
                    <p>Post-procedure monitoring should focus on signs of bleeding, perforation, or infection, though these complications are uncommon with proper technique. Patients should be observed for at least 30 minutes after the procedure and provided with clear discharge instructions regarding warning signs and follow-up contact information.</p>
                </div>
            </div>
        </section>

        <!-- Key Clinical Findings -->
        <section id="findings" class="content-section" style="margin-top: var(--spacing-2xl);">
            <h2>Key Clinical Findings and Evidence Strength</h2>
            <p>Six critical insights from the meta-analysis, organized by clinical category with evidence strength ratings and actionable recommendations.</p>

            <div class="findings-grid">
                <!-- Finding 1 -->
                <div class="finding-card">
                    <div class="category">Equipment Choice</div>
                    <div class="insight">Needle Selection Strategy</div>
                    <p style="margin-bottom: var(--spacing-md);">End-cutting FNB needles (Franseen and Fork-tip designs) significantly outperform traditional FNA and reverse-bevel FNB needles</p>
                    <div class="evidence">
                        <strong>Evidence Strength:</strong> High quality evidence from 19 randomized controlled trials
                    </div>
                    <div class="action">
                        <strong>✓ Clinical Action:</strong> Preferentially select Franseen or Fork-tip needles for solid pancreatic lesion sampling
                    </div>
                </div>

                <!-- Finding 2 -->
                <div class="finding-card">
                    <div class="category">Procedural Technique</div>
                    <div class="insight">Technique Optimization</div>
                    <p style="margin-bottom: var(--spacing-md);">Fanning technique and wet-suction methods improve diagnostic yield and sample quality</p>
                    <div class="evidence">
                        <strong>Evidence Strength:</strong> Moderate to high quality evidence
                    </div>
                    <div class="action">
                        <strong>✓ Clinical Action:</strong> Incorporate multi-pass fanning approach and wet-suction during tissue acquisition
                    </div>
                </div>

                <!-- Finding 3 -->
                <div class="finding-card">
                    <div class="category">Procedure Planning</div>
                    <div class="insight">Pass Requirements</div>
                    <p style="margin-bottom: var(--spacing-md);">Optimal pass numbers vary by needle type: 2 passes for end-cutting FNB, 3 for reverse-bevel, 4+ for FNA</p>
                    <div class="evidence">
                        <strong>Evidence Strength:</strong> High quality evidence
                    </div>
                    <div class="action">
                        <strong>✓ Clinical Action:</strong> Plan procedure duration and adjust technique based on needle selection
                    </div>
                </div>

                <!-- Finding 4 -->
                <div class="finding-card">
                    <div class="category">Patient Safety</div>
                    <div class="insight">Safety Profile</div>
                    <p style="margin-bottom: var(--spacing-md);">Adverse event rates range from 3-8.6% across studies, with most events being mild</p>
                    <div class="evidence">
                        <strong>Evidence Strength:</strong> High quality evidence from large meta-analyses
                    </div>
                    <div class="action">
                        <strong>✓ Clinical Action:</strong> Routine antibiotic prophylaxis not required for solid mass sampling
                    </div>
                </div>

                <!-- Finding 5 -->
                <div class="finding-card">
                    <div class="category">Diagnostic Accuracy</div>
                    <div class="insight">Diagnostic Performance</div>
                    <p style="margin-bottom: var(--spacing-md);">Sensitivity rates of 76.6-86.7% with adequacy rates exceeding 90% for modern needles</p>
                    <div class="evidence">
                        <strong>Evidence Strength:</strong> High quality evidence from 7 major meta-analyses
                    </div>
                    <div class="action">
                        <strong>✓ Clinical Action:</strong> Counsel patients on expected diagnostic yield and potential need for repeat procedures
                    </div>
                </div>

                <!-- Finding 6 -->
                <div class="finding-card">
                    <div class="category">Healthcare Efficiency</div>
                    <div class="insight">Resource Utilization</div>
                    <p style="margin-bottom: var(--spacing-md);">ROSE is beneficial for FNA but not necessary for end-cutting FNB needles</p>
                    <div class="evidence">
                        <strong>Evidence Strength:</strong> Moderate quality evidence
                    </div>
                    <div class="action">
                        <strong>✓ Clinical Action:</strong> Facilities without on-site cytopathology can achieve excellent outcomes with FNB needles
                    </div>
                </div>
            </div>
        </section>

        <!-- Recommendations Section -->
        <section id="recommendations" class="content-section" style="margin-top: var(--spacing-2xl);">
            <h2>Evidence-Based Recommendations for Clinical Practice</h2>

            <div class="recommendation-box">
                <h4>Primary Recommendation: Needle Selection</h4>
                <p><strong>For EUS-guided tissue acquisition of solid pancreatic lesions, end-cutting FNB needles (Franseen or Fork-tip design) are recommended as first-line agents based on superior diagnostic performance and safety profiles documented in high-quality randomized controlled trials.</strong></p>
                <ul>
                    <li>Substantially higher diagnostic accuracy and sample adequacy compared to FNA needles</li>
                    <li>Reduced need for rapid on-site evaluation (ROSE)</li>
                    <li>Lower overall procedure time and patient morbidity</li>
                    <li>Equivalent or superior safety profile</li>
                </ul>
            </div>

            <div class="recommendation-box">
                <h4>Secondary Recommendation: Technique Standardization</h4>
                <p><strong>Practitioners should adopt standardized sampling techniques including the fanning method and wet-suction approaches to optimize diagnostic yield and sample quality.</strong></p>
                <ul>
                    <li>Implement multi-pass fanning technique through lesion pathways</li>
                    <li>Utilize wet-suction or slow-pull methods rather than dry suction</li>
                    <li>Adjust number of passes based on needle type (2 for FNB, 3-4 for others)</li>
                    <li>Consider on-site adequacy assessment for FNA procedures</li>
                </ul>
            </div>

            <div class="safety-alert">
                <h4>Safety Alert: Prophylaxis and Monitoring</h4>
                <p><strong>Antibiotic prophylaxis is not routinely recommended for solid mass tissue acquisition procedures.</strong></p>
                <ul>
                    <li>Infection rates remain low (<1%) even without prophylaxis for solid lesions</li>
                    <li>Consider prophylaxis only for cystic lesions or high-risk patients</li>
                    <li>Standard post-procedure monitoring for bleeding, perforation, or infection is appropriate</li>
                    <li>Serious adverse events remain rare (<1%) when proper technique is employed</li>
                </ul>
            </div>

            <div class="recommendation-box">
                <h4>Tertiary Recommendation: Resource Planning</h4>
                <p><strong>Healthcare facilities can provide high-quality EUS-guided tissue acquisition services without rapid on-site cytopathology (ROSE) support when using modern FNB needle technology.</strong></p>
                <ul>
                    <li>Sample adequacy rates exceed 90% with FNB needles regardless of ROSE availability</li>
                    <li>This enables equitable access to procedures in resource-limited settings</li>
                    <li>Focus laboratory resources on skillful processing and interpretation rather than real-time evaluation</li>
                    <li>Train operators in visual assessment of sample quality for preliminary adequacy judgment</li>
                </ul>
            </div>
        </section>

        <!-- Quality Metrics -->
        <section style="margin-top: var(--spacing-2xl);">
            <h2>Evidence Base Summary</h2>
            <div class="metadata">
                <div class="metadata-item">
                    <div class="metadata-value">7</div>
                    <div class="metadata-label">Major Meta-Analyses Reviewed</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-value">19</div>
                    <div class="metadata-label">Randomized Controlled Trials</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-value">86.7%</div>
                    <div class="metadata-label">Maximum Sensitivity Reported</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-value">90%+</div>
                    <div class="metadata-label">Sample Adequacy (FNB)</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-value">3-8.6%</div>
                    <div class="metadata-label">Adverse Event Rate</div>
                </div>
            </div>
        </section>
    </div>

    <!-- Footer -->
    <footer>
        <p><strong>European Society of Gastrointestinal Endoscopy (ESGE) Technical Review</strong></p>
        <p>Endoscopic Ultrasound-Guided Tissue Acquisition: Meta-Analysis and Clinical Guidance | Updated 2024</p>
        <p style="margin-top: var(--spacing-md); font-size: 0.85rem;">This dashboard presents comprehensive evidence from systematic review and meta-analysis methodology. Clinical decisions should be informed by institutional protocols, patient-specific factors, and individual practitioner expertise.</p>
    </footer>

    <!-- Tooltip Container -->
    <div id="tooltip" class="tooltip" role="status" aria-live="polite" aria-hidden="true"></div>

    <!-- Scripts -->
    <script>
        // ========== Meta-Analysis Chart Scripts ==========
        const DATA_PATH = "./data/endoscopic_trials_meta_analysis_results.csv";

        const colorBySensitivity = (s) => {
            if (s == null || Number.isNaN(s)) return "#9ca3af";
            if (s >= 90) return "#10b981";
            if (s >= 80) return "#f59e0b";
            return "#ef4444";
        };

        function parseNumber(v) {
            if (v == null) return null;
            const s = String(v).trim();
            if (!s || s.toUpperCase() === "NR" || s.toUpperCase() === "N/R") return null;
            const cleaned = s.replace(/%/g, "").replace(/,/g, "");
            const num = +cleaned;
            return Number.isFinite(num) ? num : null;
        }

        function inferField(row, candidates) {
            for (const c of candidates) {
                if (row[c] != null && String(row[c]).trim() !== "") return c;
            }
            const keys = Object.keys(row);
            for (const c of candidates) {
                const found = keys.find(k => k.toLowerCase() === c.toLowerCase());
                if (found) return found;
            }
            return null;
        }

        const tooltip = d3.select("#tooltip");
        function showTooltip(html, evt) {
            tooltip.html(html).attr("aria-hidden", "false").style("opacity", 1);
            moveTooltip(evt);
        }

        function moveTooltip(evt) {
            const pad = 12;
            const { clientX: x, clientY: y } = evt;
            const node = tooltip.node();
            const rect = node.getBoundingClientRect();
            const vw = window.innerWidth, vh = window.innerHeight;
            let left = x + pad;
            let top = y + pad;
            if (left + rect.width + pad > vw) left = x - rect.width - pad;
            if (top + rect.height + pad > vh) top = y - rect.height - pad;
            tooltip.style("left", left + "px").style("top", top + "px");
        }

        function hideTooltip() {
            tooltip.attr("aria-hidden", "true").style("opacity", 0);
        }

        let pinnedStudyId = null;
        let barApi = null;
        let scatterApi = null;

        function setPinned(id) {
            pinnedStudyId = id;
            updateHighlights();
        }

        function clearPinned() {
            pinnedStudyId = null;
            updateHighlights();
        }

        function updateHighlights() {
            if (barApi) barApi.updatePinned(pinnedStudyId);
            if (scatterApi) scatterApi.updatePinned(pinnedStudyId);
        }

        window.addEventListener("keydown", (e) => {
            if (e.key === "Escape") clearPinned();
        });

        // Load data
        d3.csv(DATA_PATH, d3.autoType).then(raw => {
            if (!raw || !raw.length) {
                d3.select("#bar-count").text("No data");
                d3.select("#scat-count").text("No data");
                return;
            }

            const sampleRow = raw[0];
            const studyKey = inferField(sampleRow, ["Study", "Study Author", "Study_Name", "study", "author"]);
            const sensKey = inferField(sampleRow, ["Sensitivity_Percent", "Sensitivity (%)", "Sensitivity", "sensitivity"]);
            const nKey = inferField(sampleRow, ["Total_Patients", "Total Patients", "Patients", "N", "n"]);
            const wtKey = inferField(sampleRow, ["Weight", "Study_Weight", "Weight_Percent", "weight"]);

            const normalized = raw.map((r, i) => {
                const study = studyKey ? r[studyKey] : `Study ${i + 1}`;
                const sensitivity = sensKey ? parseNumber(r[sensKey]) : parseNumber(r.Sensitivity_Percent);
                const totalPatients = nKey ? parseNumber(r[nKey]) : parseNumber(r.Total_Patients);
                let weight = wtKey ? parseNumber(r[wtKey]) : null;
                if (weight == null && totalPatients != null) weight = totalPatients;
                const id = String(study);
                const sid = id + "||" + (totalPatients ?? "NA") + "||" + i;
                return { _idx: i, study: id, sensitivity, total_patients: totalPatients, weight, _study_id: sid, _raw: r };
            });

            const barData = normalized.filter(d => d.sensitivity != null);
            const scatterData = normalized.filter(d => d.sensitivity != null && d.total_patients != null);

            d3.select("#bar-count").text(`${barData.length} studies`);
            d3.select("#scat-count").text(`${scatterData.length} studies`);

            barApi = renderSensitivityBarChart({
                el: document.querySelector("#meta_analysis_barchart"),
                data: barData
            });

            scatterApi = renderPatientsVsSensitivityScatter({
                el: document.querySelector("#meta_analysis_scatterplot"),
                data: scatterData
            });

            updateHighlights();
        }).catch(err => {
            console.error(err);
            d3.select("#bar-count").text("Data load error");
            d3.select("#scat-count").text("Data load error");
        });

        // Bar Chart Implementation
        function renderSensitivityBarChart({ el, data }) {
            const container = d3.select(el);
            const margin = { top: 14, right: 18, bottom: 86, left: 52 };
            const svg = container.append("svg").attr("role", "img");
            const g = svg.append("g");
            const gx = g.append("g").attr("class", "axis axis-x");
            const gy = g.append("g").attr("class", "axis axis-y");
            const ggrid = g.append("g").attr("class", "grid");

            const sorted = [...data].sort((a, b) => d3.descending(a.sensitivity, b.sensitivity));

            function draw() {
                const { width: W, height: H } = el.getBoundingClientRect();
                const width = Math.max(320, W);
                const height = Math.max(260, H);
                svg.attr("viewBox", `0 0 ${width} ${height}`);

                const innerW = width - margin.left - margin.right;
                const innerH = height - margin.top - margin.bottom;
                g.attr("transform", `translate(${margin.left},${margin.top})`);

                const x = d3.scaleBand()
                    .domain(sorted.map(d => d._study_id))
                    .range([0, innerW])
                    .padding(0.18);

                const y = d3.scaleLinear()
                    .domain([0, Math.max(100, d3.max(sorted, d => d.sensitivity) ?? 100)]).nice()
                    .range([innerH, 0]);

                ggrid.attr("transform", `translate(0,0)`)
                    .call(d3.axisLeft(y).ticks(5).tickSize(-innerW).tickFormat(""))
                    .selectAll("line").attr("stroke", "#e5e7eb");

                gy.call(d3.axisLeft(y).ticks(5).tickFormat(d => `${d}%`));

                gx.attr("transform", `translate(0,${innerH})`)
                    .call(d3.axisBottom(x).tickFormat((k) => {
                        const d = sorted.find(s => s._study_id === k);
                        return d ? d.study : k;
                    }))
                    .selectAll("text")
                    .attr("text-anchor", "end")
                    .attr("dx", "-0.55em")
                    .attr("dy", "0.2em")
                    .attr("transform", "rotate(-40)");

                const bars = g.selectAll("rect.bar").data(sorted, d => d._study_id);

                bars.enter().append("rect")
                    .attr("class", "bar")
                    .attr("x", d => x(d._study_id))
                    .attr("width", x.bandwidth())
                    .attr("y", y(0))
                    .attr("height", innerH - y(0))
                    .attr("rx", 4)
                    .attr("fill", d => colorBySensitivity(d.sensitivity))
                    .attr("stroke", "rgba(17,24,39,0.12)")
                    .attr("stroke-width", 1)
                    .style("cursor", "pointer")
                    .on("mousemove", (evt, d) => {
                        showTooltip(`<div style="font-weight: bold;">${d.study}</div><div>Sensitivity: ${d.sensitivity.toFixed(1)}%</div>`, evt);
                    })
                    .on("mouseleave", hideTooltip)
                    .on("click", (evt, d) => setPinned(d._study_id))
                    .merge(bars)
                    .transition().duration(650)
                    .attr("x", d => x(d._study_id))
                    .attr("y", d => y(d.sensitivity))
                    .attr("height", d => Math.max(0, innerH - y(d.sensitivity)))
                    .attr("fill", d => colorBySensitivity(d.sensitivity));
            }

            const ro = new ResizeObserver(() => draw());
            ro.observe(el);

            function updatePinned(pinnedId) {
                g.selectAll("rect.bar")
                    .attr("opacity", d => (pinnedId && d._study_id !== pinnedId) ? 0.28 : 1)
                    .attr("stroke", d => (pinnedId && d._study_id === pinnedId) ? "#1E40AF" : "rgba(17,24,39,0.12)");
            }

            draw();
            const api = { updatePinned };
            return api;
        }

        // Scatter Plot Implementation
        function renderPatientsVsSensitivityScatter({ el, data }) {
            const container = d3.select(el);
            const margin = { top: 14, right: 18, bottom: 46, left: 58 };
            const svg = container.append("svg").attr("role", "img");
            const g = svg.append("g");
            const gx = g.append("g").attr("class", "axis axis-x");
            const gy = g.append("g").attr("class", "axis axis-y");
            const ggrid = g.append("g").attr("class", "grid");

            function draw() {
                const { width: W, height: H } = el.getBoundingClientRect();
                const width = Math.max(320, W);
                const height = Math.max(260, H);
                svg.attr("viewBox", `0 0 ${width} ${height}`);

                const innerW = width - margin.left - margin.right;
                const innerH = height - margin.top - margin.bottom;
                g.attr("transform", `translate(${margin.left},${margin.top})`);

                const x = d3.scaleLinear()
                    .domain(d3.extent(data, d => d.total_patients)).nice()
                    .range([0, innerW]);

                const y = d3.scaleLinear()
                    .domain([0, Math.max(100, d3.max(data, d => d.sensitivity) ?? 100)]).nice()
                    .range([innerH, 0]);

                const wExtent = d3.extent(data, d => d.weight ?? d.total_patients);
                const r = d3.scaleSqrt()
                    .domain([Math.max(1e-6, wExtent[0] ?? 1), wExtent[1] ?? 1])
                    .range([4, 14]);

                ggrid.call(d3.axisLeft(y).ticks(5).tickSize(-innerW).tickFormat(""))
                    .selectAll("line").attr("stroke", "#e5e7eb");

                gy.call(d3.axisLeft(y).ticks(5).tickFormat(d => `${d}%`));

                gx.attr("transform", `translate(0,${innerH})`)
                    .call(d3.axisBottom(x).ticks(5).tickFormat(d3.format(",")));

                const pts = g.selectAll("circle.pt").data(data, d => d._study_id);

                pts.enter().append("circle")
                    .attr("class", "pt")
                    .attr("cx", d => x(d.total_patients))
                    .attr("cy", d => y(d.sensitivity))
                    .attr("r", 0)
                    .attr("fill", d => colorBySensitivity(d.sensitivity))
                    .attr("fill-opacity", 0.85)
                    .attr("stroke", "rgba(17,24,39,0.18)")
                    .style("cursor", "pointer")
                    .on("mousemove", (evt, d) => {
                        showTooltip(`<div style="font-weight: bold;">${d.study}</div><div>Patients: ${d.total_patients}</div><div>Sensitivity: ${d.sensitivity.toFixed(1)}%</div>`, evt);
                    })
                    .on("mouseleave", hideTooltip)
                    .on("click", (evt, d) => setPinned(d._study_id))
                    .merge(pts)
                    .transition().duration(650)
                    .attr("cx", d => x(d.total_patients))
                    .attr("cy", d => y(d.sensitivity))
                    .attr("r", d => r(d.weight ?? d.total_patients))
                    .attr("fill", d => colorBySensitivity(d.sensitivity));
            }

            const ro = new ResizeObserver(() => draw());
            ro.observe(el);

            function updatePinned(pinnedId) {
                g.selectAll("circle.pt")
                    .attr("opacity", d => (pinnedId && d._study_id !== pinnedId) ? 0.22 : 1)
                    .attr("stroke", d => (pinnedId && d._study_id === pinnedId) ? "#1E40AF" : "rgba(17,24,39,0.18)");
            }

            draw();
            const api = { updatePinned };
            return api;
        }

        // ========== Needle Performance Chart Scripts ==========
        const chartData = {
            "grouped_bar_data": [
                { "needle_type": "FNA-19G", "diagnostic_yield": 90.2, "sample_adequacy": 93.5, "needle_ids": ["N-005"] },
                { "needle_type": "FNA-22G", "diagnostic_yield": 88.4, "sample_adequacy": 91.97, "needle_ids": ["N-001", "N-007", "N-011"] },
                { "needle_type": "FNA-25G", "diagnostic_yield": 85.1, "sample_adequacy": 89.05, "needle_ids": ["N-003", "N-009"] },
                { "needle_type": "FNB-19G", "diagnostic_yield": 92.8, "sample_adequacy": 95.1, "needle_ids": ["N-008"] },
                { "needle_type": "FNB-22G", "diagnostic_yield": 93.6, "sample_adequacy": 96.03, "needle_ids": ["N-002", "N-006", "N-012"] },
                { "needle_type": "FNB-25G", "diagnostic_yield": 91.1, "sample_adequacy": 94.0, "needle_ids": ["N-004", "N-010"] }
            ],
            "axes": { "x": { "field": "needle_type", "label": "Needle Type and Gauge" }, "y": { "label": "Performance Rate (%)", "domain": [80, 100] } },
            "groups": ["diagnostic_yield", "sample_adequacy"],
            "colors": { "diagnostic_yield": "#3B82F6", "sample_adequacy": "#F59E0B" }
        };

        const data = chartData.grouped_bar_data;
        const keys = chartData.groups;
        const groupKey = chartData.axes.x.field;
        const baseColors = chartData.colors;

        const container = d3.select("#needle_performance_chart");

        function drawNeedleChart(containerWidth) {
            container.selectAll("svg").remove();

            const height = 500 - 60;
            const margin = { top: 40, right: 30, bottom: 80, left: 60 };
            const width = containerWidth - margin.left - margin.right;

            const svg = container.append("svg")
                .attr("width", containerWidth)
                .attr("height", height + margin.top + margin.bottom)
                .attr("viewBox", `0 0 ${containerWidth} ${height + margin.top + margin.bottom}`)
                .attr("preserveAspectRatio", "xMidYMid meet");

            const chart = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x0 = d3.scaleBand()
                .domain(data.map(d => d[groupKey]))
                .range([0, width])
                .paddingInner(0.2);

            const x1 = d3.scaleBand()
                .domain(keys)
                .range([0, x0.bandwidth()])
                .padding(0.05);

            const y = d3.scaleLinear()
                .domain(chartData.axes.y.domain)
                .nice()
                .range([height, 0]);

            const color = (d_needle_type, key) => {
                const base = baseColors[key];
                if (d_needle_type.includes('22G')) return d3.color(base).darker(0.6);
                if (d_needle_type.includes('25G')) return d3.color(base).brighter(0.6);
                return base;
            };

            const xAxis = g => g
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x0).tickSizeOuter(0))
                .selectAll(".tick text")
                .style("text-anchor", "end")
                .attr("dx", "-.8em")
                .attr("dy", ".15em")
                .attr("transform", "rotate(-45)");

            const yAxis = g => g
                .call(d3.axisLeft(y).ticks(null, "s"))
                .call(g => g.select(".domain").remove());

            const grid = g => g
                .attr("stroke", "currentColor")
                .attr("stroke-opacity", 0.1)
                .call(g => g.selectAll(".tick line").clone()
                    .attr("x2", width)
                    .attr("stroke-opacity", 0.2));

            chart.append("g").call(xAxis);
            chart.append("g").call(yAxis).call(grid);

            svg.append("text")
                .attr("class", "axis-label")
                .attr("text-anchor", "middle")
                .attr("x", margin.left + width / 2)
                .attr("y", height + margin.top + 70)
                .attr("font-size", "14px")
                .attr("font-weight", "500")
                .text(chartData.axes.x.label);

            svg.append("text")
                .attr("class", "axis-label")
                .attr("transform", "rotate(-90)")
                .attr("y", 0)
                .attr("x", 0 - (height / 2) - margin.top)
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .attr("font-size", "14px")
                .attr("font-weight", "500")
                .text(chartData.axes.y.label);

            svg.append("text")
                .attr("x", containerWidth / 2)
                .attr("y", margin.top / 2 + 5)
                .attr("text-anchor", "middle")
                .style("font-size", "16px")
                .style("font-weight", "600")
                .style("fill", "#111827")
                .text("Needle Performance Comparison");

            const barGroups = chart.append("g")
                .selectAll("g")
                .data(data)
                .join("g")
                .attr("transform", d => `translate(${x0(d[groupKey])},0)`)
                .attr("class", "bar-group");

            const bars = barGroups.selectAll("rect")
                .data(d => keys.map(key => ({ key: key, value: d[key], parentData: d })))
                .join(
                    enter => enter.append("rect")
                        .attr("y", height)
                        .attr("height", 0)
                        .call(enter => enter.transition().duration(1000)
                            .attr("y", d => y(d.value))
                            .attr("height", d => height - y(d.value))),
                    update => update,
                    exit => exit.transition().duration(500).attr("height", 0).attr("y", height).remove()
                )
                .attr("x", d => x1(d.key))
                .attr("width", x1.bandwidth())
                .attr("fill", d => color(d.parentData.needle_type, d.key))
                .attr("class", "bar")
               .on("mouseover", function(event, d) {
    d3.select(this).attr("stroke", "#000").attr("stroke-width", 2);
    const metricName = d.key === 'diagnostic_yield' ? 'Accuracy' : 'Adequacy';
    showTooltip(`<div style="font-weight: bold;">${d.parentData.needle_type}</div><div>${metricName}: ${d.value}%</div>`, event);
})
.on("mouseout", function() {
    d3.select(this).attr("stroke", "none");
    hideTooltip();
})

            const legend = svg.append("g")
                .attr("transform", `translate(${margin.left}, 10)`);

            const metricItems = legend.selectAll(".legend-item")
                .data([
                    { key: 'diagnostic_yield', label: 'Accuracy (Diagnostic Yield)' },
                    { key: 'sample_adequacy', label: 'Adequacy (Sample Adequacy)' }
                ])
                .enter().append("g")
                .attr("class", "legend-item")
                .attr("transform", (d, i) => `translate(${i * 220}, 0)`);

            metricItems.append("rect")
                .attr("x", 0)
                .attr("width", 15)
                .attr("height", 15)
                .attr("fill", d => baseColors[d.key]);

            metricItems.append("text")
                .attr("x", 20)
                .attr("y", 12)
                .attr("font-size", "12px")
                .text(d => d.label);
        }

        const needleObserver = new ResizeObserver(entries => {
            for (let entry of entries) {
                const { width } = entry.contentRect;
                if (width > 0) {
                    drawNeedleChart(width);
                }
            }
        });

        needleObserver.observe(container.node());
        drawNeedleChart(container.node().getBoundingClientRect().width);

        // Smooth scrolling
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const href = this.getAttribute('href');
                const target = document.querySelector(href);
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    history.pushState(null, null, href);
                }
            });
        });
    </script>
</body>
</html>